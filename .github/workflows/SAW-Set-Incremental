name: Probely Incremental Scan Configuration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # MANDATORY for the CLI
      PROBELY_API_KEY: ${{ secrets.PROBELY_API_KEY }}
      TARGET_ID: ${{ vars.TARGET_ID }}

    steps:
      # Step 1: Install Probely CLI
      - name: Install Probely CLI
        run: |
          pip install probely
          # Test authentication setup
          probely targets get

      # Step 2: Configure Target: Set Incremental Scan ON
      - name: Set Incremental Scan Flag (ON)
        run: |
          TARGET_ID="${{ env.TARGET_ID }}"

          # 1. Create a temporary YAML file to set incremental to true
          echo 'incremental: true' > /tmp/probely_settings_on.yaml

          # 2. Update the target's settings
          probely targets update "$TARGET_ID" -f /tmp/probely_settings_on.yaml
          echo "Incremental scan flag set to TRUE on Target ID: $TARGET_ID"

      # Step 3: Configure Target: Set Incremental Scan OFF (Cleanup)
      # Ensures the target setting is reset after the workflow finishes.
      #- name: Set Incremental Scan Flag (OFF)
      #  if: always()
      #  run: |
      #    TARGET_ID="${{ env.TARGET_ID }}"

          # 1. Create temporary YAML file to set incremental to false
      #    echo 'incremental: false' > /tmp/probely_settings_disable.yaml

          # 2. Update the target's settings to disable incremental scan
      #    probely targets update "$TARGET_ID" -f /tmp/probely_settings_disable.yaml
      #    echo "Incremental scan flag reset"
